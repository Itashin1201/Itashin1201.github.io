---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { slugifyClass } from "../../../lib/blog.js";

/**
 * 日付フォーマット（YYYY-MM-DD）
 */
const formatDate = (d) =>
  new Date(d ?? Date.now()).toISOString().slice(0, 10);

/**
 * ===== 静的パス生成 =====
 * blog/*.md の category から一覧を作る
 */
export async function getStaticPaths() {
  const posts = await Astro.glob("../*.md");

  const categories = [
    ...new Set(
      posts
        .map((p) => p.frontmatter.category)
        .filter(Boolean)
        .flatMap((c) => (Array.isArray(c) ? c : [c]))
        .map((c) => String(c))
    ),
  ].sort((a, b) => a.localeCompare(b, "ja"));

  return categories.map((category) => ({
    params: { category },
  }));
}

// ===== パラメータ取得 =====
const { category } = Astro.params;

// ===== ベースURL =====
const base = import.meta.env.BASE_URL;

// ===== 記事取得 =====
const posts = await Astro.glob("../*.md");

/**
 * ===== 全カテゴリ一覧（ナビ用） =====
 */
const allCategories = [
  ...new Set(
    posts
      .map((p) => p.frontmatter.category)
      .filter(Boolean)
      .flatMap((c) => (Array.isArray(c) ? c : [c]))
      .map((c) => String(c))
  ),
].sort((a, b) => a.localeCompare(b, "ja"));

/**
 * ===== category でフィルタ =====
 */
const filteredPosts = posts.filter((p) => {
  const cats = Array.isArray(p.frontmatter.category)
    ? p.frontmatter.category
    : [p.frontmatter.category];

  return cats
    .filter(Boolean)
    .map((c) => String(c))
    .includes(String(category));
});

/**
 * ===== 抜粋生成（一覧用） =====
 *
 * 優先順位:
 * 1. frontmatter.excerpt
 * 2. lead を除外した本文1行目
 */
const makeExcerpt = async (post) => {
  if (typeof post.frontmatter?.excerpt === "string") {
    return post.frontmatter.excerpt.trim();
  }

  if (typeof post.rawContent !== "function") return "";

  const raw = await post.rawContent();
  if (!raw) return "";

  // frontmatter 除去
  const body = raw.replace(/^---[\s\S]*?---\s*/m, "");

  // lead ブロックを丸ごと除去
  const withoutLead = body.replace(
    /<p\s+class=["']lead["']>[\s\S]*?<\/p>/gi,
    ""
  );

  const lines = withoutLead
    .split(/\r?\n/)
    .map((l) => l.trim())
    .filter(Boolean)
    .filter((l) => !l.startsWith("#"))
    .filter((l) => !l.includes('class="back"'));

  if (!lines.length) return "";

  return lines[0]
    .replace(/<[^>]+>/g, "")
    .replace(/!\[.*?\]\(.*?\)/g, "")
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
    .replace(/[`*_>#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();
};

const categoryLabel = String(category ?? "");
const categoryClass = slugifyClass(categoryLabel);
---

<BaseLayout title={`Blog / ${categoryLabel}`}>
  <h1>Blog</h1>

  <p class="sub">
    <a href={`${base}blog/`}>all</a>
    {allCategories.map((c) => (
      <span>
        {" / "}
        {String(c) === categoryLabel ? (
          <span class="is-active">{c}</span>
        ) : (
          <a href={`${base}blog/category/${encodeURIComponent(c)}/`}>{c}</a>
        )}
      </span>
    ))}
  </p>

  <ul class="card-list">
    {await Promise.all(
      filteredPosts
        .sort((a, b) => {
          const da = new Date(a.frontmatter.date ?? Date.now());
          const db = new Date(b.frontmatter.date ?? Date.now());
          return db - da;
        })
        .map(async (post) => {
          const excerpt = await makeExcerpt(post);

          return (
            <li class="card">
              <a class="card-link" href={post.url}>
                <div class="card-head">
                  <p class="card-title">{post.frontmatter.title}</p>

                  <p class="card-meta">
                    {formatDate(post.frontmatter.date)}
                    <span class={`badge badge-${categoryClass}`}>
                      {categoryLabel}
                    </span>
                  </p>
                </div>

                {excerpt && <p class="card-excerpt">{excerpt}</p>}
              </a>
            </li>
          );
        })
    )}
  </ul>

  <p><a href={`${base}blog/`}>← all</a></p>
  <p><a href={base}>← Home</a></p>
</BaseLayout>
