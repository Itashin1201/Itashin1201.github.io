---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import {
  formatDate,
  normalizeCategory,
  slugifyClass,
  categoryHue,
} from "../../../lib/blog.js";

const base = import.meta.env.BASE_URL;

/**
 * ===== 静的パス生成 =====
 * blog/*.md の date から YYYY-MM を抽出
 */
export async function getStaticPaths() {
  const posts = await Astro.glob("../**/*.md");

  const months = [
    ...new Set(
      posts
        .map((p) => formatDate(p.frontmatter?.date).slice(0, 7))
        .filter(Boolean)
    ),
  ];

  return months.map((month) => ({
    params: { month },
  }));
}

// ===== パラメータ取得 =====
const { month } = Astro.params;

// ===== 記事取得 =====
const posts = await Astro.glob("../**/*.md");

/**
 * ===== 月でフィルタ =====
 */
const filteredPosts = posts.filter((p) =>
  formatDate(p.frontmatter?.date).startsWith(String(month))
);

/**
 * ===== 日付順にソート =====
 */
filteredPosts.sort((a, b) => {
  const da = new Date(a.frontmatter?.date ?? 0);
  const db = new Date(b.frontmatter?.date ?? 0);
  return db - da;
});

/**
 * 抜粋生成（一覧用）
 *
 * 優先順位:
 * 1. frontmatter.excerpt
 * 2. lead を飛ばした本文1行目
 */
const makeExcerpt = async (post) => {
  if (typeof post.frontmatter?.excerpt === "string") {
    return post.frontmatter.excerpt.trim();
  }

  if (typeof post.rawContent !== "function") return "";

  const raw = await post.rawContent();
  if (!raw) return "";

  // frontmatter 除去
  const body = raw.replace(/^---[\s\S]*?---\s*/m, "");

  // lead ブロックを丸ごと除去
  const withoutLead = body.replace(
    /<p\s+class=["']lead["']>[\s\S]*?<\/p>/gi,
    ""
  );

  const lines = withoutLead
    .split(/\r?\n/)
    .map((l) => l.trim())
    .filter(Boolean)
    .filter((l) => !l.startsWith("#"))
    .filter((l) => !l.includes('class="back"'));

  if (!lines.length) return "";

  return lines[0]
    .replace(/<[^>]+>/g, "")
    .replace(/!\[.*?\]\(.*?\)/g, "")
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
    .replace(/[`*_>#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();
};
---

<BaseLayout title={`Blog / ${month}`}>
  <h1>Blog</h1>

  <p class="sub">
    <a href={`${base}blog/`}>all</a>
    {" / "}
    <span class="is-active">{month}</span>
  </p>

  {filteredPosts.length === 0 ? (
    <>
      <p class="sub">この月の記事はありません。</p>
      <p><a href={`${base}blog/`}>← all</a></p>
      <p><a href={base}>← Home</a></p>
    </>
  ) : (
    <>
      <ul class="card-list">
        {await Promise.all(
          filteredPosts.map(async (post) => {
            const excerpt = await makeExcerpt(post);
            const cats = normalizeCategory(post.frontmatter?.category);

            return (
              <li class="card">
                <a class="card-link" href={post.url}>
                  <div class="card-head">
                    <p class="card-title">{post.frontmatter?.title}</p>

                    <p class="card-meta">
                      <span class="badge badge-month is-active">{month}</span>

                      {cats.map((c) => (
                        <span
                          class={`badge badge-${slugifyClass(c)} badge-auto`}
                          style={`--h:${categoryHue(c)}`}
                        >
                          {c}
                        </span>
                      ))}
                    </p>
                  </div>

                  {excerpt && <p class="card-excerpt">{excerpt}</p>}
                </a>
              </li>
            );
          })
        )}
      </ul>

      <p><a href={`${base}blog/`}>← all</a></p>
      <p><a href={base}>← Home</a></p>
    </>
  )}
</BaseLayout>
