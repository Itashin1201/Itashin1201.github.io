---
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
  formatDate,
  normalizeCategory,
  slugifyClass,
  categoryHue,
} from "../../lib/blog.js";

const base = import.meta.env.BASE_URL;

const getMonth = (d) => formatDate(d ?? Date.now()).slice(0, 7);

const posts = await Astro.glob("./*.md");

posts.sort((a, b) => {
  const da = new Date(a.frontmatter?.date ?? 0);
  const db = new Date(b.frontmatter?.date ?? 0);
  return db - da;
});

// カテゴリ一覧（表示用の元文字列を保持）
const categories = [
  ...new Set(posts.flatMap((p) => normalizeCategory(p.frontmatter?.category))),
].sort((a, b) => a.localeCompare(b, "ja"));

const makeExcerpt = async (post) => {
  if (typeof post.frontmatter?.excerpt === "string") {
    return post.frontmatter.excerpt.trim();
  }

  if (typeof post.rawContent !== "function") return "";

  const raw = await post.rawContent();
  if (!raw) return "";

  // frontmatter 除去
  const body = raw.replace(/^---[\s\S]*?---\s*/m, "");

  // lead ブロックを丸ごと除去
  const withoutLead = body.replace(
    /<p\s+class=["']lead["']>[\s\S]*?<\/p>/gi,
    ""
  );

  const lines = withoutLead
    .split(/\r?\n/)
    .map((l) => l.trim())
    .filter(Boolean)
    .filter((l) => !l.startsWith("#"))
    .filter((l) => !l.includes('class="back"'));

  if (!lines.length) return "";

  return lines[0]
    .replace(/<[^>]+>/g, "")
    .replace(/!\[.*?\]\(.*?\)/g, "")
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
    .replace(/[`*_>#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();
};
---

<BaseLayout title="Blog">
  <h1>Blog</h1>

  <p class="sub">
    <span class="is-active">all</span>

    {categories.map((c) => {
      const slug = slugifyClass(c);
      return (
        <>
          {" / "}
          <a href={`${base}blog/category/${slug}/`}>{c}</a>
        </>
      );
    })}
  </p>

  <ul class="card-list">
    {await Promise.all(
      posts.map(async (post) => {
        const excerpt = await makeExcerpt(post);
        const month = getMonth(post.frontmatter?.date);
        const cats = normalizeCategory(post.frontmatter?.category);

        return (
          <li class="card">
            <a class="card-link" href={post.url}>
              <div class="card-head">
                <p class="card-title">{post.frontmatter?.title}</p>

                <p class="card-meta">
                  <span class="badge badge-month">{month}</span>

                  {cats.map((c) => (
                    <span
                      class={`badge badge-${slugifyClass(c)} badge-auto`}
                      style={`--h:${categoryHue(c)}`}
                    >
                      {c}
                    </span>
                  ))}
                </p>
              </div>

              {excerpt && <p class="card-excerpt">{excerpt}</p>}
            </a>
          </li>
        );
      })
    )}
  </ul>

  <p><a href={base}>← Home</a></p>
</BaseLayout>
