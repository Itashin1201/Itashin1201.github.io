---
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
  getCategories,
  getMonths,
  makeExcerpt,
  normalizeCategory,
  slugifyClass,
  sortPostsDesc,
  formatDate,
} from "../../lib/blog.js";

const posts = await Astro.glob("./*.md");
const sorted = sortPostsDesc(posts);

const categories = getCategories(sorted);
const months = getMonths(sorted);
const base = import.meta.env.BASE_URL;
---

<BaseLayout title="Blog" description="記事一覧">
  <h1>Blog</h1>

  <!-- カテゴリナビ -->
  <p class="sub" aria-label="カテゴリ">
    <a class="is-active" href={`${base}blog/`}>all</a>
    {categories.map((c) => (
      <>
        <span class="sep" aria-hidden="true"> / </span>
        <a href={`${base}blog/category/${encodeURIComponent(c)}/`}>{c}</a>
      </>
    ))}
  </p>

  <!-- 月別ナビ -->
  <p class="sub" aria-label="月別">
    月別：
    {months.map((m, i) => (
      <>
        {i > 0 && <span class="sep" aria-hidden="true"> / </span>}
        <a href={`${base}blog/month/${m}/`}>{m}</a>
      </>
    ))}
  </p>

  <!-- 記事一覧 -->
  <ul class="card-list">
    {await Promise.all(
      sorted.map(async (post) => {
        const excerpt = await makeExcerpt(post);
        const cats = normalizeCategory(post.frontmatter?.category);

        return (
          <li class="card">
            <a class="card-link" href={post.url}>
              <div class="card-head">
                <p class="card-title">{post.frontmatter.title}</p>

                <p class="card-meta">
                  <span class="card-date">{formatDate(post.frontmatter.date)}</span>
                  {cats.map((cat) => (
                    <span class={`badge badge-${slugifyClass(cat)}`}>{cat}</span>
                  ))}
                </p>
              </div>

              {excerpt && <p class="card-excerpt">{excerpt}</p>}
            </a>
          </li>
        );
      })
    )}
  </ul>
</BaseLayout>
