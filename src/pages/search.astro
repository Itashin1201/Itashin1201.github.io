---
import BaseLayout from "../layouts/BaseLayout.astro";
import { buildSearchIndex } from "../utils/buildSearchIndex";

const index = await buildSearchIndex();
---

<BaseLayout title="Search" description="記事検索">
  <Fragment slot="head">
    <meta name="robots" content="noindex, nofollow" />
  </Fragment>

  <section class="search-container">
    <h1 class="search-title">検索</h1>

    <input
      id="search-input"
      class="search-input"
      type="search"
      placeholder="キーワードを入力（スペース区切りでAND検索）"
      autocomplete="off"
      spellcheck="false"
    />

    <p id="search-count" class="search-stats"></p>

    <ul id="search-results" class="search-results"></ul>
  </section>

  <script define:vars={{ index }}>
    const input = document.getElementById("search-input");
    const results = document.getElementById("search-results");
    const countEl = document.getElementById("search-count");

    const normalize = (s) => (s ?? "").toLowerCase();

    const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

    const escapeHtml = (s) =>
      String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");

    const highlightWords = (text, words) => {
      let out = escapeHtml(text ?? "");
      for (const w of words ?? []) {
        if (!w) continue;
        const re = new RegExp(`(${escapeRegExp(w)})`, "gi");
        out = out.replace(re, "<mark>$1</mark>");
      }
      return out;
    };

    const makeSnippet = (content, q, len = 40) => {
      const c = String(content ?? "");
      const idx = c.toLowerCase().indexOf(String(q ?? "").toLowerCase());
      if (idx === -1) return "";

      const start = Math.max(0, idx - len);
      const end = Math.min(c.length, idx + String(q ?? "").length + len);

      return highlightWords(c.slice(start, end), [q]);
    };

    const toTime = (d) => {
      if (!d) return 0;
      const t = new Date(d).getTime();
      return Number.isFinite(t) ? t : 0;
    };

    const formatDate = (d) => {
      if (!d) return "";
      const date = new Date(d);
      if (isNaN(date.getTime())) return "";
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${y}/${m}/${day}`;
    };

    const normalizeCategories = (cat) => {
      if (!cat) return [];
      if (Array.isArray(cat)) return cat.map(String);
      return [String(cat)];
    };

    const runSearch = (raw) => {
      results.innerHTML = "";
      countEl.textContent = "";

      if (!raw) return;

      const params = new URLSearchParams(window.location.search);
      params.set("q", raw);
      history.replaceState(null, "", `?${params.toString()}`);

      const words = raw
        .split(/\s+/)
        .map((w) => normalize(w.trim()))
        .filter(Boolean);

      const hits = [];

      for (const item of index) {
        const title = String(item.title ?? "");
        const description = String(item.description ?? "");
        const content = String(item.content ?? "");
        const url = String(item.url ?? "");
        const date = item.date;
        const categories = normalizeCategories(item.category ?? item.categories);

        const haystack =
          normalize(title) +
          " " +
          normalize(description) +
          " " +
          normalize(content) +
          " " +
          normalize(categories.join(" "));

        const hit = words.every((w) => haystack.includes(w));
        if (!hit) continue;

        hits.push({
          title,
          description,
          content,
          url,
          date,
          categories,
        });
      }

      hits.sort((a, b) => toTime(b.date) - toTime(a.date));

      if (hits.length === 0) {
        countEl.textContent = "0件ヒット";

        const li = document.createElement("li");
        li.className = "search-item search-empty";
        li.textContent = "該当する記事は見つかりませんでした。";
        results.appendChild(li);
        return;
      }

      for (const h of hits) {
        const snippetWord = words.find((w) => normalize(h.content).includes(w));
        const snippet = snippetWord ? makeSnippet(h.content, snippetWord) : "";

        const li = document.createElement("li");
        li.className = "search-item";

        const metaParts = [];

        if (h.date) {
          metaParts.push(
            `<span class="search-item-date">${escapeHtml(
              formatDate(h.date)
            )}</span>`
          );
        }

        if (h.categories.length) {
          metaParts.push(
            `<span class="search-item-categories">${
              h.categories
                .map(
                  (c) =>
                    `<span class="search-category">${escapeHtml(c)}</span>`
                )
                .join("")
            }</span>`
          );
        }

        li.innerHTML = `
          <a href="${h.url}" class="search-item-title">
            ${highlightWords(h.title, words)}
          </a>

          ${
            metaParts.length
              ? `<div class="search-item-meta">${metaParts.join(" ")}</div>`
              : ""
          }

          ${
            h.description
              ? `<div class="search-item-desc">${highlightWords(
                  h.description,
                  words
                )}</div>`
              : ""
          }

          ${
            snippet
              ? `<div class="search-item-excerpt">…${snippet}…</div>`
              : ""
          }
        `;

        results.appendChild(li);
      }

      countEl.textContent = `${hits.length}件ヒット`;
    };

    input.addEventListener("input", () => {
      const raw = input.value.trim();

      if (!raw) {
        results.innerHTML = "";
        countEl.textContent = "";

        const params = new URLSearchParams(window.location.search);
        params.delete("q");
        history.replaceState(null, "", location.pathname);
        return;
      }

      runSearch(raw);
    });

    const params = new URLSearchParams(window.location.search);
    const initial = params.get("q");

    if (initial) {
      input.value = initial;
      runSearch(initial);
    }
  </script>
</BaseLayout>
