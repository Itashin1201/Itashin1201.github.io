---
import BaseLayout from "../layouts/BaseLayout.astro";
import { buildSearchIndex } from "../utils/buildSearchIndex";

const index = await buildSearchIndex();
---

<BaseLayout title="Search" description="記事検索">
  <Fragment slot="head">
    <style is:global>
      .sr-only{
        position:absolute;
        width:1px;
        height:1px;
        padding:0;
        margin:-1px;
        overflow:hidden;
        clip:rect(0,0,0,0);
        white-space:nowrap;
        border:0;
      }
    </style>
  </Fragment>

  <section class="search">
    <h1 class="search-title">検索</h1>

    <label class="sr-only" for="search-input">検索キーワード</label>

    <input
      id="search-input"
      class="search-input"
      type="search"
      placeholder="キーワードを入力（スペース区切りでAND検索）"
      autocomplete="off"
      autocapitalize="off"
      spellcheck="false"
      aria-controls="search-results"
      aria-describedby="search-count"
    />

    <!-- ★ 件数表示（読み上げ対応） -->
    <p
      id="search-count"
      class="search-count"
      role="status"
      aria-live="polite"
      aria-atomic="true"
    ></p>

    <ul
      id="search-results"
      class="search-results"
      aria-label="検索結果"
    ></ul>
  </section>

  <script define:vars={{ index }}>
    const input = document.getElementById("search-input");
    const results = document.getElementById("search-results");
    const countEl = document.getElementById("search-count");

    const normalize = (s) => (s ?? "").toLowerCase();

    const escapeRegExp = (s) =>
      s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

    const highlight = (text, q) => {
      if (!q) return text;
      const re = new RegExp(`(${escapeRegExp(q)})`, "gi");
      return String(text ?? "").replace(re, "<mark>$1</mark>");
    };

    const makeSnippet = (content, q, len = 40) => {
      const c = String(content ?? "");
      const idx = c.toLowerCase().indexOf(q.toLowerCase());
      if (idx === -1) return "";

      const start = Math.max(0, idx - len);
      const end = Math.min(c.length, idx + q.length + len);
      return highlight(c.slice(start, end), q);
    };

    const toTime = (d) => {
      if (!d) return 0;
      const t = new Date(d).getTime();
      return Number.isFinite(t) ? t : 0;
    };

    const formatDate = (d) => {
      if (!d) return "";
      const date = new Date(d);
      if (isNaN(date.getTime())) return "";
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${y}/${m}/${day}`;
    };

    const normalizeCategories = (cat) => {
      if (!cat) return [];
      if (Array.isArray(cat)) return cat.map(String);
      return [String(cat)];
    };

    const runSearch = (raw) => {
      results.innerHTML = "";
      countEl.textContent = "";

      if (!raw) return;

      // ★ URL に検索語を反映
      const params = new URLSearchParams(window.location.search);
      params.set("q", raw);
      history.replaceState(null, "", `?${params.toString()}`);

      // ★ スペース区切り AND 検索
      const words = raw
        .split(/\s+/)
        .map(normalize)
        .filter(Boolean);

      const hits = [];

      for (const item of index) {
        const title = String(item.title ?? "");
        const description = String(item.description ?? "");
        const content = String(item.content ?? "");
        const url = String(item.url ?? "");
        const date = item.date;
        const categories = normalizeCategories(item.category ?? item.categories);

        const haystack =
          normalize(title) +
          " " +
          normalize(description) +
          " " +
          normalize(content) +
          " " +
          normalize(categories.join(" "));

        const hit = words.every((w) => haystack.includes(w));
        if (!hit) continue;

        hits.push({
          title,
          description,
          content,
          url,
          date,
          categories,
        });
      }

      // ★ 日付順ソート（新しい順）
      hits.sort((a, b) => toTime(b.date) - toTime(a.date));

      // ★ 0件ヒット時
      if (hits.length === 0) {
        countEl.textContent = "0件ヒット";

        const li = document.createElement("li");
        li.className = "search-item search-empty";
        li.textContent = "該当する記事は見つかりませんでした。";
        results.appendChild(li);
        return;
      }

      // ★ 描画
      for (const h of hits) {
        const snippetWord = words.find((w) =>
          normalize(h.content).includes(w)
        );
        const snippet = snippetWord
          ? makeSnippet(h.content, snippetWord)
          : "";

        const li = document.createElement("li");
        li.className = "search-item";
        li.innerHTML = `
          <a href="${h.url}" class="search-link">
            <div class="search-item-title">
              ${highlight(h.title, raw)}
            </div>

            <div class="search-item-meta">
              ${
                h.date
                  ? `<span class="search-item-date">${formatDate(h.date)}</span>`
                  : ""
              }
              ${
                h.categories.length
                  ? `<span class="search-item-categories">
                      ${h.categories
                        .map((c) => `<span class="search-category">${c}</span>`)
                        .join("")}
                    </span>`
                  : ""
              }
            </div>

            ${
              h.description
                ? `<div class="search-item-desc">
                    ${highlight(h.description, raw)}
                  </div>`
                : ""
            }
            ${
              snippet
                ? `<div class="search-item-snippet">…${snippet}…</div>`
                : ""
            }
          </a>
        `;
        results.appendChild(li);
      }

      countEl.textContent = `${hits.length}件ヒット`;
    };

    // ★ 入力イベント
    input.addEventListener("input", () => {
      const raw = input.value.trim();

      if (!raw) {
        results.innerHTML = "";
        countEl.textContent = "";

        const params = new URLSearchParams(window.location.search);
        params.delete("q");
        history.replaceState(null, "", location.pathname);
        return;
      }

      runSearch(raw);
    });

    // ★ URL クエリから初期検索
    const params = new URLSearchParams(window.location.search);
    const initial = params.get("q");

    if (initial) {
      input.value = initial;
      runSearch(initial);
    }
  </script>
</BaseLayout>
