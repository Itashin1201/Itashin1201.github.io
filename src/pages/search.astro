---
import BaseLayout from "../layouts/BaseLayout.astro";
import { buildSearchIndex } from "../utils/buildSearchIndex";

const index = await buildSearchIndex();
---

<BaseLayout title="Search" description="記事検索">
  <section class="search">
    <h1 class="search-title">検索</h1>

    <input
      id="search-input"
      class="search-input"
      type="search"
      placeholder="キーワードを入力（スペース区切りでAND検索）"
      autocomplete="off"
    />

    <!-- ★ 件数表示 -->
    <p id="search-count" class="search-count"></p>

    <ul id="search-results" class="search-results"></ul>
  </section>

  <script define:vars={{ index }}>
    const input = document.getElementById("search-input");
    const results = document.getElementById("search-results");
    const countEl = document.getElementById("search-count");

    const normalize = (s) => (s ?? "").toLowerCase();

    const escapeRegExp = (s) =>
      s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

    const highlight = (text, q) => {
      if (!q) return text;
      const re = new RegExp(`(${escapeRegExp(q)})`, "gi");
      return String(text ?? "").replace(re, "<mark>$1</mark>");
    };

    const makeSnippet = (content, q, len = 40) => {
      const c = String(content ?? "");
      const idx = c.toLowerCase().indexOf(q.toLowerCase());
      if (idx === -1) return "";

      const start = Math.max(0, idx - len);
      const end = Math.min(c.length, idx + q.length + len);
      return highlight(c.slice(start, end), q);
    };

    input.addEventListener("input", () => {
      const raw = input.value.trim();
      results.innerHTML = "";
      countEl.textContent = "";

      if (!raw) return;

      // ★ スペース区切り AND 検索
      const words = raw
        .split(/\s+/)
        .map(normalize)
        .filter(Boolean);

      let hitCount = 0;

      for (const item of index) {
        const title = String(item.title ?? "");
        const description = String(item.description ?? "");
        const content = String(item.content ?? "");
        const url = String(item.url ?? "");

        const haystack =
          normalize(title) +
          " " +
          normalize(description) +
          " " +
          normalize(content);

        // ★ すべての単語を含むか？
        const hit = words.every((w) => haystack.includes(w));
        if (!hit) continue;

        hitCount++;

        const snippetWord = words.find((w) =>
          normalize(content).includes(w)
        );
        const snippet = snippetWord
          ? makeSnippet(content, snippetWord)
          : "";

        const li = document.createElement("li");
        li.className = "search-item";
        li.innerHTML = `
          <a href="${url}" class="search-link">
            <div class="search-item-title">
              ${highlight(title, raw)}
            </div>
            ${
              description
                ? `<div class="search-item-desc">
                    ${highlight(description, raw)}
                  </div>`
                : ""
            }
            ${
              snippet
                ? `<div class="search-item-snippet">…${snippet}…</div>`
                : ""
            }
          </a>
        `;
        results.appendChild(li);
      }

      // ★ 件数表示
      countEl.textContent = `${hitCount}件ヒット`;
    });
  </script>
</BaseLayout>
