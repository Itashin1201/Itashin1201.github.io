---
import BaseLayout from "../layouts/BaseLayout.astro";
import { slugifyClass } from "../lib/blog.js";

const isDateOnly = (raw) =>
  typeof raw === "string" && /^\d{4}-\d{2}-\d{2}$/.test(raw);

const formatDate = (raw) => {
  if (isDateOnly(raw)) return raw;
  const d = raw ? new Date(raw) : null;
  if (!d || Number.isNaN(d.getTime())) return "";
  return d.toISOString().slice(0, 10);
};

const normalizeCategory = (cat) => {
  if (!cat) return [];
  const arr = Array.isArray(cat) ? cat : [cat];
  return arr.map((c) => String(c).trim()).filter(Boolean);
};

// 直近記事（blog/*.md）
const posts = await Astro.glob("./blog/**/*.md");

const recentPosts = [...posts]
  .sort((a, b) => {
    const da = new Date(a.frontmatter?.date ?? 0);
    const db = new Date(b.frontmatter?.date ?? 0);
    return db - da;
  })
  .slice(0, 5);
---

<BaseLayout title="404" description="ページが見つかりませんでした">
  <Fragment slot="head">
    <meta name="robots" content="noindex, nofollow" />
  </Fragment>

  <h1>404</h1>
  <p class="sub">ページが見つかりませんでした。</p>

  {recentPosts.length > 0 && (
    <>
      <h2>最近の投稿</h2>

      <ul class="card-list">
        {recentPosts.map((post) => {
          const cats = normalizeCategory(post.frontmatter?.category);

          return (
            <li class="card">
              <a class="card-link" href={post.url}>
                <div class="card-head">
                  <p class="card-title">{post.frontmatter?.title ?? "Untitled"}</p>

                  <p class="card-meta">
                    {formatDate(post.frontmatter?.date)}
                    {cats.map((c) => (
                      <span class={`badge badge-${slugifyClass(c)}`}>{c}</span>
                    ))}
                  </p>
                </div>
              </a>
            </li>
          );
        })}
      </ul>
    </>
  )}
</BaseLayout>
