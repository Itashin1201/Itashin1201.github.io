---
import "../styles/site.css";
import SiteHeader from "../components/SiteHeader.astro";
import SiteFooter from "../components/SiteFooter.astro";
import { SITE_NAME, SITE_DESCRIPTION, formatDate, toISO } from "../lib/blog.js";

const {
  frontmatter = {},
  title: titleProp,
  description: descriptionProp,
  ogImage: ogImageProp,
  showDate: showDateProp,
  date: dateProp,
} = Astro.props;

const siteName = SITE_NAME;

const rawTitle = titleProp ?? frontmatter.title ?? siteName;
const title = rawTitle === siteName ? siteName : `${rawTitle} | ${siteName}`;

const description =
  descriptionProp ??
  frontmatter.description ??
  frontmatter.excerpt ??
  SITE_DESCRIPTION;

const showDate = Boolean(showDateProp ?? frontmatter.showDate ?? false);
const rawDate = dateProp ?? frontmatter.date;

const displayDate = rawDate ? formatDate(rawDate) : null;
const isoDate = rawDate ? toISO(rawDate) : null;

const site = Astro.site ?? new URL("https://itashin1201.github.io");
const pageUrl = new URL(Astro.url.pathname, site).toString();
const ogType = showDate ? "article" : "website";

const base = import.meta.env.BASE_URL;

const faviconPng = `${base}favicon.png`;
const faviconSvg = `${base}favicon.svg`;

const ogImagePath = String(ogImageProp ?? frontmatter.ogImage ?? "/og.png");
const ogImageUrl = ogImagePath
  ? new URL(ogImagePath.replace(/^\//, ""), site).toString()
  : null;

const jsonLd = showDate
  ? {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      headline: rawTitle,
      description,
      url: pageUrl,
      mainEntityOfPage: pageUrl,
      datePublished: isoDate ?? undefined,
      inLanguage: "ja-JP",
      publisher: {
        "@type": "Organization",
        name: siteName,
      },
    }
  : {
      "@context": "https://schema.org",
      "@type": "WebPage",
      name: rawTitle,
      description,
      url: pageUrl,
      inLanguage: "ja-JP",
    };
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />

    <title>{title}</title>
    <meta name="description" content={description} />

    <link rel="canonical" href={pageUrl} />
    <link rel="alternate" type="application/rss+xml" title={siteName} href={`${base}rss.xml`} />

    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="ja_JP" />
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}

    {showDate && isoDate && <meta property="article:published_time" content={isoDate} />}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}

    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#fcfcfc" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f0f0f" />

    <link rel="icon" type="image/svg+xml" href={faviconSvg} />
    <link rel="icon" href={faviconPng} />

    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

    <!-- 初期テーマの適用（FOUC対策） -->
    <script>
      (() => {
        const key = "theme";
        const getStored = () => {
          try {
            return localStorage.getItem(key);
          } catch {
            return null;
          }
        };

        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        const theme = getStored() ?? (prefersDark ? "dark" : "light");

        document.documentElement.dataset.theme = theme;
        document.documentElement.style.colorScheme = theme;
      })();
    </script>

    <noscript>
      <style>
        #theme-toggle {
          display: none;
        }
      </style>
    </noscript>
  </head>

  <body>
    <a class="skip-link" href="#main">本文へスキップ</a>

    <SiteHeader currentPath={Astro.url.pathname} />

    <main id="main" class="container">
      {showDate && (
        <>
          <header class="post-header">
            <div>
              <div class="post-site">{siteName}</div>
              <h1 class="post-title">{rawTitle}</h1>
            </div>

            {displayDate && (
              <time class="post-date" datetime={isoDate ?? undefined}>
                {displayDate}
              </time>
            )}
          </header>

          <nav class="back" aria-label="パンくず">
            <a href={`${base}blog/`}>← Blog</a>
            <span class="sep" aria-hidden="true"> / </span>
            <a href={base}>Home</a>
          </nav>
        </>
      )}

      {showDate ? (
        <article>
          <slot />
        </article>
      ) : (
        <div class="page">
          <slot />
        </div>
      )}
    </main>

    <SiteFooter />

    <!-- Theme toggle -->
    <script>
      (() => {
        const key = "theme";
        const btn = document.getElementById("theme-toggle");
        if (!btn) return;

        const getStored = () => {
          try {
            return localStorage.getItem(key);
          } catch {
            return null;
          }
        };

        const setStored = (v) => {
          try {
            localStorage.setItem(key, v);
          } catch {
            // ignore
          }
        };

        const getPreferred = () => {
          try {
            return window.matchMedia("(prefers-color-scheme: dark)").matches
              ? "dark"
              : "light";
          } catch {
            return "light";
          }
        };

        const apply = (theme) => {
          document.documentElement.dataset.theme = theme;
          document.documentElement.style.colorScheme = theme;

          const isDark = theme === "dark";
          btn.setAttribute("aria-pressed", String(isDark));
          btn.setAttribute(
            "aria-label",
            isDark ? "ライトテーマに切り替える" : "ダークテーマに切り替える"
          );
          btn.setAttribute("title", isDark ? "ライトテーマ" : "ダークテーマ");
          btn.innerHTML = isDark
            ? '<span aria-hidden="true">☀︎</span>'
            : '<span aria-hidden="true">☾</span>';
        };

        apply(getStored() ?? getPreferred());

        btn.addEventListener("click", () => {
          const current =
            document.documentElement.dataset.theme === "dark" ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          setStored(next);
          apply(next);
        });
      })();
    </script>
  </body>
</html>
