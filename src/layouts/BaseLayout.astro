---
import "../styles/site.css";
import { getLastUpdated } from "../utils/getLastUpdated";

const {
  frontmatter = {},
  title: propTitle,
  description: propDescription,
  showDate: propShowDate,
  date: propDate,
} = Astro.props;

const title = propTitle ?? frontmatter.title ?? "愛と幽相";
const description =
  propDescription ?? frontmatter.description ?? "断片を書き留める場所。";
const showDate = propShowDate ?? frontmatter.showDate ?? false;
const rawDate = propDate ?? frontmatter.date;

const dateObj = rawDate ? new Date(rawDate) : null;
const isValidDate = dateObj instanceof Date && !isNaN(dateObj.getTime());

const displayDate = isValidDate ? dateObj.toISOString().slice(0, 10) : null;
const isoDate = isValidDate ? dateObj.toISOString() : null;

// NOTE: siteUrl はあなたの公開URLに合わせて固定（Astro.site があればそちら優先）
const siteUrl = "https://itashin1201.github.io";
const site = Astro.site ?? new URL(siteUrl);

const pageUrl = new URL(Astro.url.pathname, site).toString();
const canonicalUrl = pageUrl;

const ogImageUrl = new URL(`${import.meta.env.BASE_URL}og.png`, site).toString();
const ogType = showDate && isoDate ? "article" : "website";

const lastUpdated = await getLastUpdated();

// ===== ナビ制御 =====
const base = import.meta.env.BASE_URL;
const normalizePath = (p) => (p.endsWith("/") ? p : `${p}/`);
const currentPath = normalizePath(Astro.url.pathname);

const isHome = currentPath === normalizePath(base);
const isBlogIndex = currentPath === normalizePath(`${base}blog/`);
const isSearchPage = currentPath === normalizePath(`${base}search/`);
const isBlogChild =
  currentPath.startsWith(normalizePath(`${base}blog/`)) && !isBlogIndex;
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph -->
    <meta property="og:site_name" content="愛と幽相" />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:alt" content={title} />

    {ogType === "article" && isoDate && (
      <meta property="article:published_time" content={isoDate} />
    )}

    <!-- Twitter / X -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:url" content={pageUrl} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={title} />

    <link rel="icon" href={`${import.meta.env.BASE_URL}favicon.png`} />
    <slot name="head" />

    <script>
      (() => {
        const saved = localStorage.getItem("theme");
        const prefersDark = window
          .matchMedia("(prefers-color-scheme: dark)")
          .matches;
        const theme = saved ?? (prefersDark ? "dark" : "light");
        document.documentElement.dataset.theme = theme;
      })();
    </script>
  </head>

  <body>
    <button
      id="theme-toggle"
      type="button"
      aria-label="Toggle theme"
      aria-pressed="false"
    >
      dark
    </button>

    <main class="container">
      {!isHome && (
        <nav class="site-nav">
          {isBlogIndex ? (
            <>
              <a href={base}>Home</a>
              <span class="sep"> / </span>
              <a href={`${base}blog/`}>Blog</a>
              <span class="sep"> / </span>
              <a href={`${base}search/`}>Search</a>
            </>
          ) : isBlogChild ? (
            <>
              <a href={base}>Home</a>
              <span class="sep"> / </span>
              <a href={`${base}search/`}>Search</a>
            </>
          ) : isSearchPage ? (
            <>
              <a href={base}>Home</a>
              <span class="sep"> / </span>
              <a href={`${base}blog/`}>Blog</a>
            </>
          ) : (
            <>
              <a href={base}>Home</a>
              <span class="sep"> / </span>
              <a href={`${base}blog/`}>Blog</a>
              <span class="sep"> / </span>
              <a href={`${base}search/`}>Search</a>
            </>
          )}
        </nav>
      )}

      {showDate && (
        <header class="post-header">
          <div>
            <div class="post-site">愛と幽相</div>
            <h1 class="post-title">{title}</h1>
          </div>

          {displayDate && (
            <time class="post-date" datetime={isoDate}>
              {displayDate}
            </time>
          )}
        </header>
      )}

      <article>
        <slot />
      </article>
    </main>

    <footer class="site-footer">
      <div class="copyright">© {new Date().getFullYear()} itashin</div>
      {lastUpdated && <div class="last-updated">最終更新：{lastUpdated}</div>}
    </footer>

    <script>
      const key = "theme";
      const btn = document.getElementById("theme-toggle");

      const apply = (theme) => {
        document.documentElement.dataset.theme = theme;
        btn.textContent = theme === "dark" ? "light" : "dark";
        btn.setAttribute("aria-pressed", String(theme === "dark"));
      };

      const saved = localStorage.getItem(key);
      const prefersDark = window
        .matchMedia("(prefers-color-scheme: dark)")
        .matches;
      const initial = saved ?? (prefersDark ? "dark" : "light");
      apply(initial);

      btn.addEventListener("click", () => {
        const next =
          document.documentElement.dataset.theme === "dark" ? "light" : "dark";
        localStorage.setItem(key, next);
        apply(next);
      });
    </script>
  </body>
</html>
